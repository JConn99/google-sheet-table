<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  padding: 20px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: transparent;
}

#filter-container {
  margin-bottom: 20px;
  padding: 15px;
  background: #f9fafb;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

#filter-container input {
  padding: 8px 12px;
  margin: 5px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 14px;
  font-family: inherit;
  min-width: 250px;
}

#filter-container button {
  padding: 8px 16px;
  margin: 5px;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
  min-width: 140px;
  text-align: center;
}

#filter-container button:hover {
  background: #5568d3;
}

#filter-container button.active {
  background: #764ba2;
}

.filter-row {
  margin: 10px 0;
}

.column-filters {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

#custom-table {
  max-width: 100%;
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

th {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 16px;
  text-align: left;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.5px;
  cursor: pointer;
  user-select: none;
  position: relative;
  white-space: nowrap;
}

th:hover {
  background: linear-gradient(135deg, #5568d3 0%, #63408b 100%);
}

th.sortable::after {
  content: ' ⇅';
  opacity: 0.5;
  font-size: 14px;
}

th.sorted-asc::after {
  content: ' ▲';
  opacity: 1;
}

th.sorted-desc::after {
  content: ' ▼';
  opacity: 1;
}

td {
  padding: 14px 16px;
  border-bottom: 1px solid #e5e7eb;
  color: #374151;
}

tr:last-child td {
  border-bottom: none;
}

tbody tr:hover {
  background: #f9fafb;
}

.loading {
  text-align: center;
  padding: 40px;
  color: #6b7280;
}

.result-count {
  margin-top: 10px;
  font-size: 14px;
  color: #6b7280;
}
</style>
</head>
<body>
<div id="filter-container">
  <div class="filter-row">
    <strong>Search Last Name:</strong>
    <input type="text" id="search-input" placeholder="Search last name..." onkeyup="applyFilters()">
  </div>
  
  <div class="filter-row">
    <strong>Show Columns:</strong>
    <div class="column-filters">
      <button id="btn-saturday" onclick="filterColumns('saturday')">Saturday Info</button>
      <button id="btn-sunday" onclick="filterColumns('sunday')">Sunday Info</button>
      <button id="btn-total" onclick="filterColumns('total')">Total Info</button>
      <button onclick="clearFilters()">Clear Filters</button>
    </div>
  </div>
  
  <div class="result-count" id="result-count"></div>
</div>

<div id="custom-table">
  <div class="loading">Loading data...</div>
</div>

<script>
var API_URL = 'https://script.google.com/macros/s/AKfycbzAhG4WtObR3IpGeCcsnmp6RKImp3f_cU_S4xM-paDpELd4UxizE_Yfp_cbtGLPQY2m6w/exec';

var percentageColumns = [
  'saturday_poss_points_per',
  'saturday_win_per',
  'sunday_poss_points_per',
  'sunday_win_per',
  'total_poss_points_per',
  'total_win_per'
];

var tableData = [];
var allHeaders = [];
var displayHeaders = [];
var filteredData = [];
var currentSort = { column: null, direction: 'asc' };
var activeColumnFilter = null;

// Function to make header names readable
function formatHeaderName(header) {
  // Special cases for percentage columns
  if (header.indexOf('poss_points_per') !== -1) {
    var prefix = header.split('_poss_points_per')[0];
    return prefix.charAt(0).toUpperCase() + prefix.slice(1) + ' Possible Points Percentage';
  }
  if (header.indexOf('win_per') !== -1) {
    var prefix = header.split('_win_per')[0];
    return prefix.charAt(0).toUpperCase() + prefix.slice(1) + ' Win Percentage';
  }
  
  // Default: replace underscores with spaces and capitalize each word
  return header.split('_').map(function(word) {
    return word.charAt(0).toUpperCase() + word.slice(1);
  }).join(' ');
}

function formatValue(header, value) {
  if (value === '' || value === null || value === undefined) {
    return '0';
  }
  
  if (percentageColumns.indexOf(header) !== -1) {
    var numValue = parseFloat(value);
    if (!isNaN(numValue)) {
      return (numValue * 100).toFixed(1) + '%';
    }
    return '0.0%';
  }
  
  return value;
}

function getRawValue(header, value) {
  if (value === '' || value === null || value === undefined) {
    return 0;
  }
  
  if (percentageColumns.indexOf(header) !== -1) {
    var numValue = parseFloat(value);
    return isNaN(numValue) ? 0 : numValue;
  }
  
  var num = parseFloat(value);
  return isNaN(num) ? value : num;
}

function getDisplayValue(header, value) {
  return formatValue(header, value).toString().toLowerCase();
}

window.sortTable = function(columnIndex) {
  var column = displayHeaders[columnIndex];
  
  if (currentSort.column === columnIndex) {
    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.column = columnIndex;
    currentSort.direction = 'asc';
  }
  
  filteredData.sort(function(a, b) {
    var aVal = getRawValue(column, a[column]);
    var bVal = getRawValue(column, b[column]);
    
    if (typeof aVal === 'string' && typeof bVal === 'string') {
      aVal = aVal.toLowerCase();
      bVal = bVal.toLowerCase();
    }
    
    if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
    if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
    return 0;
  });
  
  renderTable();
}

window.filterColumns = function(type) {
  activeColumnFilter = type;
  
  // Remove active class from all buttons
  document.getElementById('btn-saturday').classList.remove('active');
  document.getElementById('btn-sunday').classList.remove('active');
  document.getElementById('btn-total').classList.remove('active');
  
  // Add active class to clicked button
  document.getElementById('btn-' + type).classList.add('active');
  
  // Always include last_name column
  displayHeaders = ['last_name'];
  
  // Add columns based on filter type
  for (var i = 0; i < allHeaders.length; i++) {
    var header = allHeaders[i];
    if (header === 'last_name') continue;
    
    if (type === 'saturday' && header.indexOf('saturday') !== -1) {
      displayHeaders.push(header);
    } else if (type === 'sunday' && header.indexOf('sunday') !== -1) {
      displayHeaders.push(header);
    } else if (type === 'total' && header.indexOf('total') !== -1) {
      displayHeaders.push(header);
    }
  }
  
  applyFilters();
}

window.applyFilters = function() {
  var searchTerm = document.getElementById('search-input').value.toLowerCase();
  
  filteredData = tableData.filter(function(row) {
    // Filter by last_name only
    if (searchTerm) {
      var lastName = getDisplayValue('last_name', row['last_name']);
      if (lastName.indexOf(searchTerm) === -1) {
        return false;
      }
    }
    
    return true;
  });
  
  document.getElementById('result-count').textContent = 
    'Showing ' + filteredData.length + ' of ' + tableData.length + ' rows';
  
  renderTable();
}

window.clearFilters = function() {
  document.getElementById('search-input').value = '';
  activeColumnFilter = null;
  
  // Remove active class from all buttons
  document.getElementById('btn-saturday').classList.remove('active');
  document.getElementById('btn-sunday').classList.remove('active');
  document.getElementById('btn-total').classList.remove('active');
  
  // Show all columns
  displayHeaders = allHeaders.slice();
  filteredData = tableData.slice();
  
  document.getElementById('result-count').textContent = 
    'Showing ' + filteredData.length + ' of ' + tableData.length + ' rows';
  
  renderTable();
}

function renderTable() {
  var html = '<table><thead><tr>';
  
  for (var i = 0; i < displayHeaders.length; i++) {
    var sortClass = 'sortable';
    if (currentSort.column === i) {
      sortClass = currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc';
    }
    var readableHeader = formatHeaderName(displayHeaders[i]);
    html += '<th class="' + sortClass + '" onclick="sortTable(' + i + ')">' + readableHeader + '</th>';
  }
  html += '</tr></thead><tbody>';
  
  for (var j = 0; j < filteredData.length; j++) {
    html += '<tr>';
    for (var k = 0; k < displayHeaders.length; k++) {
      var value = filteredData[j][displayHeaders[k]];
      var formattedValue = formatValue(displayHeaders[k], value);
      html += '<td>' + formattedValue + '</td>';
    }
    html += '</tr>';
  }
  
  html += '</tbody></table>';
  document.getElementById('custom-table').innerHTML = html;
}

fetch(API_URL)
  .then(function(res) { return res.json(); })
  .then(function(response) {
    tableData = response.data;
    filteredData = tableData.slice();
    var tableDiv = document.getElementById('custom-table');
    
    if (!tableData || tableData.length === 0) {
      tableDiv.innerHTML = '<p>No data available</p>';
      return;
    }
    
    allHeaders = Object.keys(tableData[0]);
    displayHeaders = allHeaders.slice();
    
    document.getElementById('result-count').textContent = 
      'Showing ' + filteredData.length + ' of ' + tableData.length + ' rows';
    renderTable();
  })
  .catch(function(error) {
    console.error('Error:', error);
    document.getElementById('custom-table').innerHTML = '<p style="color: red;">Error loading data.</p>';
  });
</script>
</body>
</html>
