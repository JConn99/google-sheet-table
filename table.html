<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
body {
  margin: 0;
  padding: 20px;
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  background: transparent;
}

#filter-container {
  margin-bottom: 20px;
  padding: 15px;
  background: #f9fafb;
  border-radius: 8px;
  border: 1px solid #e5e7eb;
}

#filter-container input,
#filter-container select {
  padding: 8px 12px;
  margin: 5px;
  border: 1px solid #d1d5db;
  border-radius: 4px;
  font-size: 14px;
  font-family: inherit;
}

#filter-container input {
  min-width: 200px;
}

#filter-container select {
  min-width: 150px;
}

#filter-container button {
  padding: 8px 16px;
  margin: 5px;
  background: #667eea;
  color: white;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 500;
}

#filter-container button:hover {
  background: #5568d3;
}

.filter-row {
  margin: 5px 0;
}

#custom-table {
  max-width: 100%;
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

th {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 16px;
  text-align: left;
  font-weight: 600;
  text-transform: uppercase;
  font-size: 12px;
  letter-spacing: 0.5px;
  cursor: pointer;
  user-select: none;
  position: relative;
}

th:hover {
  background: linear-gradient(135deg, #5568d3 0%, #63408b 100%);
}

th.sortable::after {
  content: ' ⇅';
  opacity: 0.5;
  font-size: 14px;
}

th.sorted-asc::after {
  content: ' ▲';
  opacity: 1;
}

th.sorted-desc::after {
  content: ' ▼';
  opacity: 1;
}

td {
  padding: 14px 16px;
  border-bottom: 1px solid #e5e7eb;
  color: #374151;
}

tr:last-child td {
  border-bottom: none;
}

tbody tr:hover {
  background: #f9fafb;
}

.loading {
  text-align: center;
  padding: 40px;
  color: #6b7280;
}

.result-count {
  margin-top: 10px;
  font-size: 14px;
  color: #6b7280;
}
</style>
</head>
<body>
<div id="filter-container">
  <div class="filter-row">
    <strong>Search:</strong>
    <input type="text" id="search-input" placeholder="Search all columns..." onkeyup="applyFilters()">
  </div>
  <div class="filter-row">
    <strong>Filter by Column:</strong>
    <select id="filter-column" onchange="applyFilters()">
      <option value="">All Columns</option>
    </select>
    <input type="text" id="filter-value" placeholder="Filter value..." onkeyup="applyFilters()">
  </div>
  <div class="filter-row">
    <button onclick="clearFilters()">Clear Filters</button>
  </div>
  <div class="result-count" id="result-count"></div>
</div>

<div id="custom-table">
  <div class="loading">Loading data...</div>
</div>

<script>
var API_URL = 'https://script.google.com/macros/s/AKfycbzAhG4WtObR3IpGeCcsnmp6RKImp3f_cU_S4xM-paDpELd4UxizE_Yfp_cbtGLPQY2m6w/exec';

var percentageColumns = [
  'saturday_poss_points_per',
  'saturday_win_per',
  'sunday_poss_points_per',
  'sunday_win_per',
  'total_poss_points_per',
  'total_win_per'
];

var tableData = [];
var tableHeaders = [];
var filteredData = [];
var currentSort = { column: null, direction: 'asc' };

function formatValue(header, value) {
  if (value === '' || value === null || value === undefined) {
    return '0';
  }
  
  if (percentageColumns.indexOf(header) !== -1) {
    var numValue = parseFloat(value);
    if (!isNaN(numValue)) {
      return (numValue * 100).toFixed(1) + '%';
    }
    return '0.0%';
  }
  
  return value;
}

function getRawValue(header, value) {
  if (value === '' || value === null || value === undefined) {
    return 0;
  }
  
  if (percentageColumns.indexOf(header) !== -1) {
    var numValue = parseFloat(value);
    return isNaN(numValue) ? 0 : numValue;
  }
  
  var num = parseFloat(value);
  return isNaN(num) ? value : num;
}

function getDisplayValue(header, value) {
  // Get the value as it appears in the table for filtering
  return formatValue(header, value).toString().toLowerCase();
}

window.sortTable = function(columnIndex) {
  var column = tableHeaders[columnIndex];
  
  if (currentSort.column === columnIndex) {
    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
  } else {
    currentSort.column = columnIndex;
    currentSort.direction = 'asc';
  }
  
  filteredData.sort(function(a, b) {
    var aVal = getRawValue(column, a[column]);
    var bVal = getRawValue(column, b[column]);
    
    if (typeof aVal === 'string' && typeof bVal === 'string') {
      aVal = aVal.toLowerCase();
      bVal = bVal.toLowerCase();
    }
    
    if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
    if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
    return 0;
  });
  
  renderTable();
}

window.applyFilters = function() {
  var searchTerm = document.getElementById('search-input').value.toLowerCase();
  var filterColumn = document.getElementById('filter-column').value;
  var filterValue = document.getElementById('filter-value').value.toLowerCase();
  
  filteredData = tableData.filter(function(row) {
    // Apply global search
    if (searchTerm) {
      var matchFound = false;
      for (var i = 0; i < tableHeaders.length; i++) {
        var displayValue = getDisplayValue(tableHeaders[i], row[tableHeaders[i]]);
        if (displayValue.indexOf(searchTerm) !== -1) {
          matchFound = true;
          break;
        }
      }
      if (!matchFound) return false;
    }
    
    // Apply column-specific filter
    if (filterColumn && filterValue) {
      var columnValue = getDisplayValue(filterColumn, row[filterColumn]);
      if (columnValue.indexOf(filterValue) === -1) {
        return false;
      }
    }
    
    return true;
  });
  
  // Update result count
  document.getElementById('result-count').textContent = 
    'Showing ' + filteredData.length + ' of ' + tableData.length + ' rows';
  
  renderTable();
}

window.clearFilters = function() {
  document.getElementById('search-input').value = '';
  document.getElementById('filter-column').value = '';
  document.getElementById('filter-value').value = '';
  filteredData = tableData.slice();
  document.getElementById('result-count').textContent = 
    'Showing ' + filteredData.length + ' of ' + tableData.length + ' rows';
  renderTable();
}

function renderTable() {
  var html = '<table><thead><tr>';
  
  for (var i = 0; i < tableHeaders.length; i++) {
    var sortClass = 'sortable';
    if (currentSort.column === i) {
      sortClass = currentSort.direction === 'asc' ? 'sorted-asc' : 'sorted-desc';
    }
    html += '<th class="' + sortClass + '" onclick="sortTable(' + i + ')">' + tableHeaders[i] + '</th>';
  }
  html += '</tr></thead><tbody>';
  
  for (var j = 0; j < filteredData.length; j++) {
    html += '<tr>';
    for (var k = 0; k < tableHeaders.length; k++) {
      var value = filteredData[j][tableHeaders[k]];
      var formattedValue = formatValue(tableHeaders[k], value);
      html += '<td>' + formattedValue + '</td>';
    }
    html += '</tr>';
  }
  
  html += '</tbody></table>';
  document.getElementById('custom-table').innerHTML = html;
}

function initializeFilters() {
  var filterColumnSelect = document.getElementById('filter-column');
  filterColumnSelect.innerHTML = '<option value="">All Columns</option>';
  
  for (var i = 0; i < tableHeaders.length; i++) {
    var option = document.createElement('option');
    option.value = tableHeaders[i];
    option.textContent = tableHeaders[i];
    filterColumnSelect.appendChild(option);
  }
}

fetch(API_URL)
  .then(function(res) { return res.json(); })
  .then(function(response) {
    tableData = response.data;
    filteredData = tableData.slice();
    var tableDiv = document.getElementById('custom-table');
    
    if (!tableData || tableData.length === 0) {
      tableDiv.innerHTML = '<p>No data available</p>';
      return;
    }
    
    tableHeaders = Object.keys(tableData[0]);
    initializeFilters();
    document.getElementById('result-count').textContent = 
      'Showing ' + filteredData.length + ' of ' + tableData.length + ' rows';
    renderTable();
  })
  .catch(function(error) {
    console.error('Error:', error);
    document.getElementById('custom-table').innerHTML = '<p style="color: red;">Error loading data.</p>';
  });
</script>
</body>
</html>
